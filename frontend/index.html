<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>çƒçƒterra - åœ°çƒç§‘å­¦ç§‘æ™®æ™ºèƒ½ä½“</title>
    <meta name="description" content="çƒçƒterraæ˜¯ä¸€ä¸ªäº’åŠ¨çš„3Dåœ°çƒç§‘å­¦ç§‘æ™®æ™ºèƒ½ä½“ï¼Œå¸¦ä½ æ¢ç´¢åœ°çƒçš„å¥¥ç§˜">
    <meta name="theme-color" content="#4a9eff">
    
    <!-- æ·»åŠ favicon -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    
    <!-- PWAæ”¯æŒ -->
    <link rel="manifest" href="/manifest.json">
    <!-- <link rel="apple-touch-icon" sizes="192x192" href="icon-192x192.png"> -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="çƒçƒterra">
    
    <link rel="stylesheet" href="style.css?v=3.0">
</head>
<body>
    <div id="container">
        <div id="loading">
            <div class="loading-spinner"></div>
            <p>åŠ è½½åœ°çƒä¸­...</p>
        </div>
        
        <!-- ä¿¡æ¯é¢æ¿æ§åˆ¶æŒ‰é’® -->
        <div id="info-toggle" class="info-toggle" onclick="toggleInfoPanel()">
            <span class="info-icon">â„¹ï¸</span>
            <span class="info-text">ä¿¡æ¯</span>
        </div>
        
        <div id="info-panel" class="hidden">
            <h1>ğŸŒ çƒçƒterra</h1>
            <p class="subtitle">åœ°çƒç§‘å­¦ç§‘æ™®æ™ºèƒ½ä½“</p>
            
            <!-- æ–°å¢: åœ°æ ‡æœç´¢æ¡† -->
            <div class="landmark-search">
                <input type="text" id="landmark-search" placeholder="æœç´¢åœ°æ ‡..." />
                <button onclick="searchLandmarks()">ğŸ”</button>
            </div>
            
            <div class="controls-info" id="controls-info">
                <p><strong>æ“ä½œè¯´æ˜ï¼š</strong></p>
                <div id="desktop-controls">
                    <p>ğŸ–±ï¸ é¼ æ ‡æ‹–æ‹½ï¼šæ—‹è½¬è§†è§’</p>
                    <p>ğŸ¯ æ»šè½®ï¼šç¼©æ”¾</p>
                    <p>ğŸ–±ï¸ å³é”®æ‹–æ‹½ï¼šå¹³ç§»è§†è§’</p>
                    <p>ğŸŒ åœ°çƒä¼šè‡ªåŠ¨è‡ªè½¬</p>
                </div>
                <div id="mobile-controls" style="display: none;">
                    <p>ğŸ‘† åŒæŒ‡æåˆï¼šç¼©æ”¾åœ°çƒ</p>
                    <p>ğŸŒ åœ°çƒä¼šè‡ªåŠ¨è‡ªè½¬</p>
                </div>
                <p>ğŸ“ ç‚¹å‡»æ ‡è®°ï¼šæŸ¥çœ‹è¯¦æƒ…</p>
            </div>
            <div class="location-info">
                <p><strong>å½“å‰åæ ‡ï¼š</strong></p>
                <p id="coordinates">ç»åº¦: 0Â°, çº¬åº¦: 0Â°</p>
            </div>
            <div class="landmarks-toggle">
                <button id="landmarks-btn" onclick="toggleLandmarksList()">ğŸ—ºï¸ åœ°æ ‡åˆ—è¡¨</button>
                <button id="reset-btn" onclick="resetView()">ğŸ”„ é‡ç½®è§†è§’</button>
            </div>
        </div>
        
        <div id="landmarks-panel" class="hidden">
            <h3>ğŸŒ å…¨çƒåœ°æ ‡</h3>
            <div id="landmarks-list">
                <!-- åœ°æ ‡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- èŠå¤©æŒ‰é’® -->
        <div id="chat-toggle" class="chat-toggle" onclick="toggleChat()">
            <span class="chat-icon">ğŸ¤–</span>
            <span class="chat-text">èŠå¤©</span>
        </div>
        
        <!-- èŠå¤©æ¡† -->
        <div id="chat-panel" class="chat-panel hidden">
            <div class="chat-header">
                <div class="chat-title">
                    <span class="chat-avatar">ğŸŒ</span>
                    <div>
                        <h3>çƒçƒterra</h3>
                        <p class="chat-subtitle">åœ°çƒç§‘å­¦ä¸“å®¶</p>
                    </div>
                </div>
                <button class="chat-close" onclick="toggleChat()">Ã—</button>
            </div>
            <div id="chat-messages" class="chat-messages">
                <div class="message bot-message">
                    <div class="message-avatar">ğŸŒ</div>
                    <div class="message-content">
                        <p>å—¨ï¼Œæˆ‘æ˜¯çƒçƒTerraï¼ğŸŒâœ¨<br>
                        ä½ å¥½å¥‡çš„åœ°çƒæ¢é™©å‘å¯¼æ¥äº†ï¼æƒ³çŸ¥é“åœ°éœ‡ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿï¼Ÿå°é£æ˜¯æ€ä¹ˆè½¬èµ·æ¥çš„ï¼Ÿè¿˜æ˜¯æƒ³çœ‹çœ‹ä¸–ç•Œå„åœ°çš„å¥‡ç‰¹åœ°è²Œï¼Ÿ<br>
                        ä»åœ°å¿ƒçš„ç§˜å¯†åˆ°å¤§æ°”å±‚çš„å¥¥ç§˜ï¼Œä»å–œé©¬æ‹‰é›…å±±è„‰åˆ°é©¬é‡Œäºšçº³æµ·æ²Ÿï¼Œæˆ‘éƒ½èƒ½å¸¦ä½ å»æ¢ç´¢ï¼<br>
                        å¿«å‘Šè¯‰æˆ‘ï¼Œä»Šå¤©æƒ³å»åœ°çƒçš„å“ªä¸ªè§’è½å†’é™©å‘¢ï¼ŸğŸ—ºï¸</p>
                        <div class="recommended-questions">
                            <button class="question-btn" onclick="askRecommendedQuestion('ä¸ºä»€ä¹ˆåœ°çƒæœ‰ç£åœºï¼Ÿæ²¡æœ‰ç£åœºä¼šæ€æ ·ï¼Ÿ')">ğŸ§² ä¸ºä»€ä¹ˆåœ°çƒæœ‰ç£åœºï¼Ÿæ²¡æœ‰ç£åœºä¼šæ€æ ·ï¼Ÿ</button>
                            <button class="question-btn" onclick="askRecommendedQuestion('ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿåœ°éœ‡ï¼Ÿåœ°éœ‡èƒ½é¢„æµ‹å—ï¼Ÿ')">ğŸŒ‹ ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿåœ°éœ‡ï¼Ÿåœ°éœ‡èƒ½é¢„æµ‹å—ï¼Ÿ</button>
                            <button class="question-btn" onclick="askRecommendedQuestion('åœ°çƒç³»ç»Ÿæ˜¯å¦å…·æœ‰è‡ªæˆ‘è°ƒèŠ‚èƒ½åŠ›ï¼Ÿç›–äºšå‡è¯´æœ‰é“ç†å—ï¼Ÿ')">ğŸŒ åœ°çƒç³»ç»Ÿæ˜¯å¦å…·æœ‰è‡ªæˆ‘è°ƒèŠ‚èƒ½åŠ›ï¼Ÿç›–äºšå‡è¯´æœ‰é“ç†å—ï¼Ÿ</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input type="text" id="chat-input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." maxlength="500">
                    <button id="send-btn" onclick="sendMessage()" disabled>
                        <span class="send-icon">ğŸ“¤</span>
                    </button>
                </div>
                <div class="chat-status" id="chat-status"></div>
                <div class="chat-controls">
                    <button class="control-btn" onclick="clearChat()" title="æ¸…é™¤èŠå¤©å†å²">ğŸ—‘ï¸ æ¸…é™¤å†å²</button>
                    <button class="control-btn" onclick="resetConversation()" title="é‡ç½®å¯¹è¯(è·å–æ–°ID)">ğŸ”„ é‡ç½®å¯¹è¯</button>
                    <button class="control-btn" onclick="checkConversationStatus()" title="æ£€æŸ¥å¯¹è¯çŠ¶æ€">ğŸ“Š æ£€æŸ¥çŠ¶æ€</button>
                </div>
            </div>
        </div>
        
        <canvas id="earth-canvas"></canvas>
    </div>

    <!-- ä½¿ç”¨æœ¬åœ°Three.jsæ–‡ä»¶ -->
    <script src="three.min.js"></script>
    
    <!-- æ£€æŸ¥æ˜¯å¦æˆåŠŸåŠ è½½THREEï¼Œå¦‚æœå¤±è´¥åˆ™å°è¯•CDN -->
    <script>
        if (typeof THREE === 'undefined') {
            console.log('æœ¬åœ°Three.jsåŠ è½½å¤±è´¥ï¼Œå°è¯•CDN...');
            document.write('<script src="https://unpkg.com/three@0.150.1/build/three.min.js"><\/script>');
        } else {
            console.log('Three.js åŠ è½½æˆåŠŸ (æœ¬åœ°ç‰ˆæœ¬)', THREE.REVISION);
        }
    </script>
    
    <!-- OrbitControls -->
    <script>
        // æ‰‹åŠ¨æ·»åŠ OrbitControlsä»£ç ï¼Œé¿å…CDNé—®é¢˜
        if (typeof THREE !== 'undefined') {
            // å®šä¹‰è§¦æ‘¸å¸¸é‡
            THREE.TOUCH = {
                ROTATE: 0,
                PAN: 1,
                DOLLY_PAN: 2,
                DOLLY_ROTATE: 3,
                DOLLY: 4  // çº¯ç¼©æ”¾
            };
            
            // ç®€åŒ–ç‰ˆOrbitControls
            THREE.OrbitControls = function ( object, domElement ) {
                this.object = object;
                this.domElement = domElement;
                this.enabled = true;
                this.target = new THREE.Vector3();
                this.enableZoom = true;
                this.enableRotate = true;
                this.enablePan = true;
                this.enableDamping = false;
                this.dampingFactor = 0.05;
                this.minDistance = 0;
                this.maxDistance = Infinity;
                this.minPolarAngle = 0;
                this.maxPolarAngle = Math.PI;
                this.autoRotate = false;
                this.autoRotateSpeed = 0;
                
                // è§¦æ‘¸æ§åˆ¶è®¾ç½®
                this.touches = {
                    ONE: THREE.TOUCH.ROTATE,
                    TWO: THREE.TOUCH.DOLLY_PAN
                };
                
                // ç®€åŒ–çš„å®ç°
                let scope = this;
                let isUserInteracting = false;
                let rotateStart = new THREE.Vector2();
                let rotateEnd = new THREE.Vector2();
                let rotateDelta = new THREE.Vector2();
                
                // è§¦æ‘¸å˜é‡
                let touchZoomDistanceStart = 0;
                let touchZoomDistanceEnd = 0;
                
                this.update = function() {
                    // ä¸å†ä½¿ç”¨autoRotateï¼Œåœ°çƒè‡ªè½¬ç”±animateå‡½æ•°æ§åˆ¶
                };
                
                this.addEventListener = function(type, listener) {};
                this.reset = function() {};
                
                // é¼ æ ‡äº‹ä»¶
                if (this.enableRotate) {
                    this.domElement.addEventListener('mousedown', onMouseDown, false);
                }
                if (this.enableZoom) {
                    this.domElement.addEventListener('wheel', onMouseWheel, false);
                }
                
                // è§¦æ‘¸äº‹ä»¶
                this.domElement.addEventListener('touchstart', onTouchStart, { passive: false });
                this.domElement.addEventListener('touchmove', onTouchMove, { passive: false });
                this.domElement.addEventListener('touchend', onTouchEnd, { passive: false });
                
                function onMouseDown(event) {
                    if (!scope.enableRotate) return;
                    isUserInteracting = true;
                    document.addEventListener('mousemove', onMouseMove, false);
                    document.addEventListener('mouseup', onMouseUp, false);
                }
                
                function onMouseMove(event) {
                    if (!isUserInteracting || !scope.enableRotate) return;
                    scope.object.rotation.y += event.movementX * 0.01;
                    scope.object.rotation.x += event.movementY * 0.01;
                    scope.object.rotation.x = Math.max(-1.5, Math.min(1.5, scope.object.rotation.x));
                }
                
                function onMouseUp() {
                    isUserInteracting = false;
                    document.removeEventListener('mousemove', onMouseMove, false);
                    document.removeEventListener('mouseup', onMouseUp, false);
                }
                
                function onMouseWheel(event) {
                    if (!scope.enableZoom) return;
                    event.preventDefault();
                    let distance = scope.object.position.length();
                    distance += event.deltaY * 0.01;
                    distance = Math.max(scope.minDistance, Math.min(scope.maxDistance, distance));
                    scope.object.position.normalize().multiplyScalar(distance);
                }
                
                function onTouchStart(event) {
                    event.preventDefault();
                    
                    if (event.touches.length === 1) {
                        // å•æŒ‡æ“ä½œ - æ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦å…è®¸æ—‹è½¬
                        if (scope.touches.ONE === THREE.TOUCH.ROTATE && scope.enableRotate) {
                            isUserInteracting = true;
                        }
                    } else if (event.touches.length === 2) {
                        // åŒæŒ‡æ“ä½œ - ç¼©æ”¾
                        if (scope.enableZoom) {
                            isUserInteracting = true;
                            const dx = event.touches[0].pageX - event.touches[1].pageX;
                            const dy = event.touches[0].pageY - event.touches[1].pageY;
                            touchZoomDistanceEnd = touchZoomDistanceStart = Math.sqrt(dx * dx + dy * dy);
                        }
                    }
                }
                
                function onTouchMove(event) {
                    event.preventDefault();
                    
                    if (event.touches.length === 1) {
                        // å•æŒ‡æ—‹è½¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                        if (scope.touches.ONE === THREE.TOUCH.ROTATE && scope.enableRotate && isUserInteracting) {
                            const touch = event.touches[0];
                            scope.object.rotation.y += (touch.clientX - (rotateStart.x || touch.clientX)) * 0.01;
                            scope.object.rotation.x += (touch.clientY - (rotateStart.y || touch.clientY)) * 0.01;
                            scope.object.rotation.x = Math.max(-1.5, Math.min(1.5, scope.object.rotation.x));
                            rotateStart.set(touch.clientX, touch.clientY);
                        }
                    } else if (event.touches.length === 2) {
                        // åŒæŒ‡ç¼©æ”¾
                        if (scope.enableZoom && isUserInteracting) {
                            const dx = event.touches[0].pageX - event.touches[1].pageX;
                            const dy = event.touches[0].pageY - event.touches[1].pageY;
                            touchZoomDistanceEnd = Math.sqrt(dx * dx + dy * dy);
                            
                            const factor = touchZoomDistanceStart / touchZoomDistanceEnd;
                            let distance = scope.object.position.length() * factor;
                            distance = Math.max(scope.minDistance, Math.min(scope.maxDistance, distance));
                            scope.object.position.normalize().multiplyScalar(distance);
                            
                            touchZoomDistanceStart = touchZoomDistanceEnd;
                        }
                    }
                }
                
                function onTouchEnd(event) {
                    event.preventDefault();
                    isUserInteracting = false;
                    touchZoomDistanceStart = 0;
                    touchZoomDistanceEnd = 0;
                    rotateStart.set(0, 0);
                }
            };
        }
    </script>
    
    <script src="script.js?v=3.1"></script>
    <script src="chat.js?v=1.0"></script>
    
    <!-- PWAæ³¨å†Œ -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('SWæ³¨å†ŒæˆåŠŸ: ', registration.scope);
                    })
                    .catch(function(registrationError) {
                        console.log('SWæ³¨å†Œå¤±è´¥: ', registrationError);
                    });
            });
        }
    </script>
    
    <!-- ç™¾åº¦åƒå¸†åµŒå…¥å¼èŠå¤©ç»„ä»¶ -->
    <script src="https://agi-dev-platform-web.bj.bcebos.com/ai_apaas/embed/output/embedLiteSDK.js?responseExpires=0"></script>
    <script>
        // åˆå§‹åŒ–å¹¶ä¿å­˜åµŒå…¥å¼ç»„ä»¶å®ä¾‹åˆ°å…¨å±€å˜é‡
        window.qianfanEmbed = new EmbedLiteSDK({
            appId: 'ac6acc7c-9e7c-4909-8bc0-5ca667a5e0b6', 
            code: 'embedYO03B4h0DeIkQbu5UHQI'
        });
        
        // ç›‘å¬åµŒå…¥å¼ç»„ä»¶åŠ è½½å®Œæˆ
        document.addEventListener('embedLiteReady', function(e) {
            console.log('åµŒå…¥å¼èŠå¤©ç»„ä»¶åŠ è½½å®Œæˆ');
        });
    </script>
</body>
</html> 